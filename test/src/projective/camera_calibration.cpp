/* camera_calibration.cpp
 *
 * Author: Fabian Meyer
 * Created On: 25 Sep 2019
 */

#include "assert/eigen_require.h"
#include <cve/projective/camera_calibration.h>

using namespace cve;

typedef double Scalar;
typedef Eigen::Matrix<Scalar, Eigen::Dynamic, Eigen::Dynamic> Matrix;
typedef Eigen::Matrix<Scalar, 3, 3> Matrix3;

TEST_CASE("camera_calibration")
{
    Scalar eps = 1e-3;
    CameraCalibration<Scalar> calib;
    std::vector<Matrix> points(6);

    points[0].resize(2, 64);
    points[0] <<
        0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222, 0, 0.888889, 1.77778, 2.66667, 3.55556, 4.44444, 5.33333, 6.22222,
        -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -0.5, -1.38889, -1.38889, -1.38889, -1.38889, -1.38889, -1.38889, -1.38889, -1.38889, -2.27778, -2.27778, -2.27778, -2.27778, -2.27778, -2.27778, -2.27778, -2.27778, -3.16667, -3.16667, -3.16667, -3.16667, -3.16667, -3.16667, -3.16667, -3.16667, -4.05556, -4.05556, -4.05556, -4.05556, -4.05556, -4.05556, -4.05556, -4.05556, -4.94444, -4.94444, -4.94444, -4.94444, -4.94444, -4.94444, -4.94444, -4.94444, -5.83333, -5.83333, -5.83333, -5.83333, -5.83333, -5.83333, -5.83333, -5.83333, -6.72222, -6.72222, -6.72222, -6.72222, -6.72222, -6.72222, -6.72222, -6.72222;

    points[1].resize(2, 64);
    points[1] <<
        63.43921044061905, 116.28035530429925, 170.832696837639, 226.86846784643092, 284.39049681092564, 342.94734878624087, 402.3786597601738, 462.1274425133204, 65.23122858749674, 118.03455996929435, 172.4001628011494, 228.3763298691328, 285.9599818293802, 344.4946104549276, 403.8459777399356, 463.4920805680829, 67.41852441860404, 119.9797486243428, 174.3238625443077, 230.1838096287344, 287.5611603285242, 346.0130820428916, 405.0691571796657, 464.5704816546494, 70.14223570324233, 122.32352404284693, 176.46490664036455, 232.11481951556652, 289.2384705637213, 347.4351242513755, 406.2245843264435, 465.523092053566, 72.98910805171106, 125.08462582171373, 178.69793526089177, 234.15457949117916, 290.8999148937342, 348.6042810219786, 407.1003826281793, 465.97490215671394, 76.16710425446853, 127.84130625665146, 181.25563306460265, 236.23365624522017, 292.4588748930849, 349.69159518414097, 407.61257650834744, 465.9575137851354, 79.51086377384169, 130.72333248421154, 183.58843498593697, 238.07365326917147, 293.83525186897225, 350.4720860096607, 407.6771939926995, 465.4727459783836, 83.91124369483907, 134.6306229879343, 187.12492527401574, 240.9165999666756, 295.9948347437614, 351.92099001188586, 408.526106159246, 465.65621424059066,
        405.57679766845445, 409.17858333240645, 412.46038130831136, 415.8660937726924, 418.52561560191134, 420.86862691813366, 423.0391036991514, 424.698227870397, 349.6907027733138, 352.3848197690597, 355.22103054344683, 357.91781697436124, 360.10319357751825, 362.0295359924154, 363.76076192996504, 365.13759047476947, 293.9966296559016, 295.99698063712265, 297.9337108902351, 299.78921796236745, 301.40750765891795, 302.8615772015612, 304.3961263202983, 305.55438512850714, 238.36941313466673, 239.49645820189613, 240.6218321347413, 241.93435972850207, 242.95729366739042, 244.16872583239353, 245.03205353779114, 246.1775260488285, 183.3229223758834, 183.7455308332811, 184.17588311789484, 184.67925083341942, 185.18321246496123, 185.89123718698139, 186.57807793920117, 187.31221128756985, 129.06339843948058, 128.69339578967518, 128.48382994356055, 128.40228658023835, 128.45043466848207, 128.56678071162221, 128.87175784461283, 129.54762183209073, 76.19294770503798, 74.89725312608094, 74.10334829270418, 73.31630178493887, 72.8290660404367, 72.61004387294248, 72.68022846248228, 72.99430375637395, 24.449609965519024, 22.615817432586987, 20.95504911622112, 19.803724782257063, 18.78111909293907, 18.26130021351024, 17.991288029486068, 18.207516413716252;

    points[2].resize(2, 64);
    points[2] <<
        74.95173767129486, 127.82252063924655, 181.84295543141715, 237.12102868837414, 293.18762081188373, 349.9194813487409, 406.99836748473933, 464.0038872204549, 71.29513562533573, 124.85876349944454, 179.86316734884443, 236.16730364497818, 293.27736544637816, 351.0824026293796, 409.237369470657, 467.22528388902015, 67.86990551193277, 122.24349452326419, 178.05244645201566, 235.25161840257564, 293.3421842610446, 352.244687578723, 411.28840290448835, 470.2577135508111, 64.75555278435645, 119.76637875562051, 176.42971625799623, 234.50709637791988, 293.509685485772, 353.26154729214403, 413.24709354626935, 473.2646573411307, 62.05888397044999, 117.73390592637882, 175.03678176202516, 233.843922785267, 293.7353783366339, 354.2987015865003, 415.07650445349185, 475.93976313131697, 59.42172685465347, 115.77372481183963, 173.7876505758194, 233.17777139665816, 293.83886263182103, 355.0451067222118, 416.52661520032, 478.0945516167279, 57.381598023792804, 114.06968575478231, 172.48640816024854, 232.5402874913855, 293.77480578263754, 355.60254590572043, 417.7098217713907, 479.76163911602845, 56.318999635465964, 113.57672948180384, 172.64025607990797, 233.0920953642154, 294.595375305751, 356.9130755447031, 419.55084342282595, 481.9960132940097,
        409.09267757581756, 412.2041930215117, 414.98756134254074, 417.61764879300614, 419.83695853105417, 421.5926044159451, 422.9847167646322, 424.13271228547285, 357.6942633948015, 360.14700880628453, 362.63102501359486, 364.81259801424477, 366.85190781014205, 368.4938576438795, 369.89469625644654, 370.8611321393432, 304.15854104273126, 306.2762726445089, 308.2732746098075, 310.25100921872996, 311.8508340598895, 313.2272280064658, 314.50849735444723, 315.65909088057236, 249.00623198940218, 250.43888034309919, 251.97401222878347, 253.35502367526004, 254.65618927479554, 256.0041375953487, 257.07095581919504, 258.25170894636994, 192.35510221204711, 193.02538500590614, 193.94265924027135, 194.7555301320053, 195.803516382801, 196.78147138286732, 197.92445468093158, 198.98183996148856, 134.179092671166, 134.2042774623179, 134.43075359705995, 134.79815066776965, 135.48528605204007, 136.27656990753377, 137.15292513462248, 138.37478658889506, 75.06465950658283, 74.48587987763723, 74.1320277432348, 73.97411559857558, 74.14953797150977, 74.58162759095768, 75.50504947291813, 76.6873930120917, 15.145508059133235, 13.862934726294393, 12.56360906633607, 12.318481092420383, 11.997888025947153, 12.395678586510696, 13.012494018315612, 14.223576647359778;

    points[3].resize(2, 64);
    points[3] <<
        137.22826265754128, 180.16912538559387, 225.75104300713795, 274.06364553672006, 325.0825655137707, 378.98388879169886, 435.3672294584237, 494.4674585750879, 139.23128225352067, 182.0956177210248, 227.77183133008973, 276.0055916396826, 327.097679977267, 380.80323390705894, 437.3161307891978, 496.5259261096069, 141.46861683034936, 184.29973188639207, 229.8310926051587, 278.01506574164137, 329.0596770303812, 382.7568264528644, 439.1076523453959, 498.20319243576364, 144.02690053062062, 186.77027044489435, 231.9840600903537, 280.1539980943389, 331.0118139734911, 384.4956750345099, 440.6855471964129, 499.3795257678252, 146.62005436903283, 189.19997922929988, 234.47993108486497, 282.40479346925423, 332.8725536440233, 386.04522463062176, 441.98872926357933, 500.2881129514194, 149.54446166549693, 192.02698305909564, 236.82599989671436, 284.4659594003672, 334.5057948401551, 387.3688333267982, 442.62430145277176, 500.5166852013382, 152.6941041120487, 194.4685357560373, 239.10030401088463, 286.1734015784083, 335.89624139722815, 388.29937338446825, 443.04706241212943, 500.1510622911001, 155.5435287110069, 197.3847531971697, 241.7067121175821, 288.40151605688584, 337.76488292829356, 389.5822762790428, 443.87428361015714, 500.4966854081226,
        394.36338179898917, 399.3808729240103, 404.3630066605049, 409.5082639415724, 414.4173174859092, 419.4444513141882, 424.3107037363906, 428.932852781578, 343.82883420371434, 347.34328675090325, 350.75951555377674, 354.34376925094153, 358.0025148055112, 361.3858374680148, 364.6838758307422, 368.1086909818487, 293.0742154572436, 295.09574730151354, 297.15398989000835, 299.2639193616573, 301.1764953193146, 303.2440789128329, 305.0927844274493, 306.9549946877856, 242.6718680818291, 243.14467479496832, 243.8498032983192, 244.45522572209077, 244.8505182769471, 245.32783257739558, 245.90994004685442, 246.37083852688656, 192.63570149359077, 191.81378016298464, 190.88652205812798, 190.16562891048716, 188.97316935994638, 188.21089480538737, 187.07929156095236, 186.29351513598155, 143.23993886908247, 140.9532635865463, 138.81359207082616, 136.5489122466196, 134.1289277694715, 131.66081409515422, 129.3503753046519, 127.09848842356901, 94.76135047288122, 91.27497856507841, 87.444925082216, 83.8750500079042, 80.30694821030578, 76.65330292365267, 72.98931424770032, 69.48749337226295, 47.17733319510865, 42.56321054309326, 37.593701930234246, 32.77894423415306, 27.740386011495826, 22.957895518479983, 18.171841356899918, 13.507183887278705;

    points[4].resize(2, 64);
    points[4] <<
        84.04443096693421, 141.72697580728473, 198.84160209514897, 255.29048125241334, 310.8563877944848, 365.14154221159794, 418.12334794462424, 469.44710399654394, 85.37953462163631, 142.7532108282927, 199.95031028127778, 256.34156128825185, 311.84877343792976, 366.12525672838075, 418.9949604588119, 470.1986100852902, 87.04076708049563, 144.21931172056645, 201.17687679253876, 257.42839689778856, 312.8184806124381, 366.9415531832442, 419.6441969265521, 470.7675811162934, 89.06173929681611, 145.96439095961492, 202.59943341937188, 258.6686748785791, 313.7390153168726, 367.7233746668972, 420.113032118686, 471.0576589443452, 91.45015936007158, 148.0457547322132, 204.28229364512413, 259.9922098463268, 314.7415031780298, 368.3041944424955, 420.40232294270123, 471.02419150718754, 94.22109692137786, 150.38300521582437, 206.02628128325355, 261.31965129541436, 315.51314998670256, 368.67232120839816, 420.43715162551564, 470.69111452804435, 97.09281156928235, 152.53290892825265, 207.78903737094635, 262.3885788772523, 316.226951361783, 368.8336445940755, 420.06460840397295, 469.81002562166196, 101.00970782167697, 155.89552189367052, 210.3982534058584, 264.16507192752834, 317.29261990558007, 369.2755474222269, 419.85385101377045, 469.08155005643766,
        410.1275601822925, 411.0320047945014, 411.6115154837549, 411.76413178856507, 411.53170846505816, 410.8468994517686, 410.0749383223604, 408.82236579329094, 352.6911734612626, 353.88222801154996, 354.8418530581463, 355.46307001296077, 355.86636171875597, 355.9227752530399, 355.72307403893296, 355.32112770491875, 295.2717623705317, 296.71624962895044, 298.10851203004745, 299.1476476870004, 300.11760776718137, 300.7183058251445, 301.30253200591716, 301.80643590258603, 238.14258944451336, 239.86653197931125, 241.44571867066892, 242.9334839653305, 244.50985588031136, 245.96045515835198, 247.15602820342573, 248.43204055677325, 181.50862597428082, 183.50408392570867, 185.48891579397565, 187.5286338669944, 189.52704594808074, 191.56246710653886, 193.62240157124128, 195.60366374803445, 125.83800085780929, 128.0039309465524, 130.28172108604093, 132.64727749332698, 135.3265229245645, 138.04082049845894, 140.61661255146953, 143.51880260260336, 71.24292423931813, 73.7637828589439, 76.26360580901712, 79.26306974110837, 82.25464259975655, 85.58785180482208, 88.8609379105335, 92.32389867224812, 18.103363519108168, 20.719960397126016, 23.82758215460897, 27.051830520038266, 30.574770973198902, 34.33603808098457, 38.23308678448411, 42.382012370500085;

    points[5].resize(2, 64);
    points[5] <<
        78.69152413080967, 128.29439935441943, 177.63828694566752, 226.48313127424362, 274.5120681898539, 321.77684077639236, 368.00846360843946, 413.00920312893993, 87.2750900075558, 137.13560548427256, 186.71930701859588, 235.757047274741, 284.08995820462525, 331.47996676392114, 377.7901601525455, 422.95528530172487, 96.22722627556054, 146.3266757897717, 196.07660977250805, 245.3015525636926, 293.70515404531454, 341.27168011925556, 387.61397095150375, 432.85379725703115, 105.76987137759865, 155.90726182663596, 205.74754579084382, 255.01448793989965, 303.5249047584565, 351.1606006718723, 397.5246027866596, 442.6749445217156, 115.55515770161269, 165.7239651344489, 215.5811670509886, 264.8471636771777, 313.2797347183294, 360.92048234333413, 407.2747766363627, 452.4328355521711, 125.5000916587322, 175.75003948223736, 225.54837592523282, 274.81650943865327, 323.220998382946, 370.74171260986896, 416.95788441953715, 461.94249916671635, 135.59500108806986, 185.6240791490438, 235.34012260563037, 284.4691708117143, 332.833108988705, 380.1922222397722, 426.349378861027, 471.22500254530297, 146.81572231828488, 196.40807656079377, 245.61747263405593, 294.3435232270571, 342.2968085631704, 389.3648436325567, 435.31748654193984, 479.9683091718671,
        361.274660727371, 369.9386524721016, 378.4916243402773, 386.64544523893477, 394.2401800907817, 401.6339307093484, 408.56230340859327, 415.05304633130703, 312.3582673315689, 321.4333060528775, 330.2996162749264, 338.8932021696882, 347.03871206962543, 354.8189011224688, 362.3469946965432, 369.5578590050164, 262.8284574907546, 272.1622311755597, 281.46178259575737, 290.51739617797705, 299.1425100185318, 307.5200377950307, 315.57312860649995, 323.3358006879324, 212.94380761429647, 222.5838684841567, 232.07514019977162, 241.45342474035775, 250.65898774180872, 259.63920826891535, 268.23107809439415, 276.60784060339756, 162.77631551896766, 172.68245133907658, 182.50929719856993, 192.255739265883, 201.9774639129238, 211.40237541849658, 220.57496933979866, 229.70137495840632, 112.39703788025982, 122.5925342852821, 132.81346283315006, 143.00174967590672, 153.10193278556466, 163.09280096297266, 172.93773537702012, 182.6272619160663, 62.45438144874405, 72.85382636689017, 83.37430640616488, 93.90734796651384, 104.50707669328405, 114.96845339129112, 125.44433125750037, 135.7352493232785, 12.912321760037827, 23.499184264817504, 34.31023015857057, 45.31418106954909, 56.3059646055059, 67.3109068705477, 78.14776640636657, 89.10713199270751;

    Matrix3 K = calib(points);
    Matrix3 Kexp;
    Kexp <<
        871.906, -0.383464, 293.669,
        0, 871.727, 212.447,
        0, 0, 1;
    REQUIRE_MATRIX_APPROX(Kexp, K, eps);
}
